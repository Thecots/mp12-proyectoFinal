<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<main>
  <aside>
    <nav>
      <li onclick="window.location.href= '/'"><a><i class="fa-solid fa-house"></i>Inicio</a></li>
      <li  onclick="window.location.href= '/dashboard'"><a><i class="fa-solid fa-gauge"></i>Dashboard</a></li>
      <li class="active" onclick="window.location.href= '/dashboard/usuarios'"><a><i class="fa-solid fa-users"></i>Usuarios</a></li>
      <li onclick="window.location.href= '/dashboard/posts'"><a href="/dashboard/dashboard"><i class="fa-solid fa-message"></i>Posts</a></li>
      <!--  <li><a href="/dashboard/categorias"><i class="fa-solid fa-bookmark"></i>categorias</a></li>
      <li><a href="/dashboard/foros"><i class="fa-solid fa-inbox"></i>Foros</a></li>
      
    </nav> -->
  </aside>
  <section class="main">
    <header>
      <h1>Usuarios</h1>
    </header>
    <section class="content">
      <table id="example" class="display tablausers" style="width:100%">
        <thead>
            <tr>
                <th>Id</th>
                <th>Titulo</th>
                <th>Usuario</th>
                <th>Fecha</th>
                <th>Ver</th>
                <th>Visitas</th>
                <th>Comentarios</th>
                <th>Eliminar</th>
                <th>Editar</th>
            </tr>
        </thead>
        <tbody>
            <% for (let i = 0; i < users.length; i++) { %>
              <% let x = users[i].class == 1 ? "Owner" : users[i].class == 2 ? "Admin" :"Usuario"%>
              <tr>
                <td style="text-align:start;"><%= users[i].id %></td>
                <td  style="text-align:start;"><a class="linkuser" href="/profile/<%= users[i].id %>/temas/"><%= users[i].username %></a></td>
                <td><%= users[i].created %></td>
                <% if (users[i].class == 4) { %>
                  <td><a class="linkuser" href="/profile/<%= users[i].id %>/temas/"><img src="/img/defaultuser.png"></a></td>
                 <% }else{ %>
                  <td><a class="linkuser" href="/profile/<%= users[i].id %>/temas/"><img src="<%= users[i].picture %>"></a></td>
                  <%}%>
                <td><%= x %> </td>
                <% if (session.class == 1) { %>
                  <% if (x == "Usuario" || x == "Admin") { %>
                    <td><button class="btn red" onclick="Eliminar('<%= i%>','<%= users[i].id %>','<%= users[i].username %>')">Eliminar</button></td>
                    <td><button class="btn grn" onclick="editar('<%= i%>','<%= users[i].id %>')">Editar</button></td>
                        <% }else{ %>
                          <td style="color: rgb(111, 111, 111);">No se puede</td>
                          <td style="color: rgb(111, 111, 111);">No se puede</td>
                        <% } %>  
                  <% } %>
                <% if (session.class == 2) { %>
                  <% if (x == "Usuario") { %>
                    <td><button class="btn red" onclick="Eliminar('<%= i%>','<%= users[i].id %>','<%= users[i].username %>')">Eliminar</button></td>
                    <td><button class="btn grn" onclick="editar('<%= i%>','<%= users[i].id %>')">Editar</button></td>
                      <% }else{ %>
                        <td style="color: rgb(111, 111, 111);">No se puede</td>
                        <td style="color: rgb(111, 111, 111);">No se puede</td>
                      <% } %>  
                <% } %>
              </tr>
         <% } %>
      </tbody>
    </section>
  </section>
</main>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://kit.fontawesome.com/43dede5314.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
  $(document).ready(function() {
    $('#example').DataTable();
} );

function editar(i,e){
  console.log({i,e});
}

function Eliminar(i,id,usr){
  Swal.fire({
  title: `Quieres eliminar a\n${usr}?`,
  text: 'Se eliminarÃ¡n todos los likes, comentarios y post.\nLos cambios son irreversibles',
  showDenyButton: true,
  showCancelButton: true,
  showConfirmButton: false,
  denyButtonText: `Eliminar`,
}).then((result) => {
  if (result.isDenied) {
    EliminarSi(id,i);
  }
})
}

function EliminarSi(id,i){
  fetch('/deleteUser',
          {method: 'POST',
          body: JSON.stringify({
            id
          }),
          headers:{
            'Content-Type': 'application/json'
          }}
        ).then(res => res.json())
        .then(res => {
         if(res.ok){
          Swal.fire(
            'Usuario eliminado correctamente',
            '',
            'success',
          ).then(() => {
            window.location.href = '/dashboard/usuarios'
          })
         }else{
          Swal.fire(
            'Ha ocurrido un error',
            '',
            'error',
            )
         }
      });
}



</script>